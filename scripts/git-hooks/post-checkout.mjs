#!/usr/bin/env node

/**
 * Git post-checkout hook for auto-configuring worktree environments.
 * This runs after 'git checkout' or 'git worktree add'.
 *
 * Args from git:
 *   process.argv[2] - previous HEAD ref
 *   process.argv[3] - new HEAD ref
 *   process.argv[4] - flag (1 = branch checkout, 0 = file checkout)
 */

import fs from 'fs';
import path from 'path';
import { execSync } from 'child_process';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

const isBranchCheckout = process.argv[4] === '1';

if (!isBranchCheckout) {
  process.exit(0);
}

// Check if we're in a worktree by looking for .git file (not directory)
const gitPath = path.join(process.cwd(), '.git');
const isWorktree = fs.existsSync(gitPath) && fs.statSync(gitPath).isFile();

if (!isWorktree) {
  process.exit(0);
}

const envLocalPath = path.join(process.cwd(), '.env.local');

// Don't overwrite existing .env.local
if (fs.existsSync(envLocalPath)) {
  process.exit(0);
}

console.log('Detected new worktree - configuring ports in .env.local');

// Find the highest MCP port in use across all worktrees
let maxPort = 64343;

try {
  const worktreeList = execSync('git worktree list --porcelain', { encoding: 'utf8' });
  const worktreePaths = worktreeList
    .split('\n')
    .filter(line => line.startsWith('worktree '))
    .map(line => line.replace('worktree ', '').trim());

  for (const worktreePath of worktreePaths) {
    const envPath = path.join(worktreePath, '.env.local');
    if (fs.existsSync(envPath)) {
      const content = fs.readFileSync(envPath, 'utf8');
      const match = content.match(/^YAAK_PLUGIN_MCP_SERVER_PORT=(\d+)/m);
      if (match) {
        const port = parseInt(match[1], 10);
        if (port >= maxPort) {
          maxPort = port + 1;
        }
      }
    }
  }
} catch (err) {
  console.error('Warning: Could not check other worktrees for port conflicts:', err.message);
  // Continue with default port
}

// Create .env.local with unique port
const envContent = `# Auto-generated by git post-checkout hook
# This file configures ports for this worktree to avoid conflicts

# MCP Server port (main worktree uses 64343)
YAAK_PLUGIN_MCP_SERVER_PORT=${maxPort}
`;

fs.writeFileSync(envLocalPath, envContent, 'utf8');
console.log(`Created .env.local with YAAK_PLUGIN_MCP_SERVER_PORT=${maxPort}`);
console.log('Vite dev server will auto-increment from port 1420 if already in use');

// Run npm init to install dependencies and bootstrap
console.log('\nRunning npm run init to install dependencies and bootstrap...');
try {
  execSync('npm run init', { stdio: 'inherit' });
  console.log('\n✓ Worktree setup complete!');
} catch (err) {
  console.error('\n✗ Failed to run npm run init. You may need to run it manually.');
  process.exit(1);
}
